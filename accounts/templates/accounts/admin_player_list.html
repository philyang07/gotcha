{% extends "base.html" %}

{% block content %}
{% if game.in_progress == False and players %}
    <p>Targets and secret codes sent to players</p>
    <form action="{% url 'accounts:start_game' %}" method="POST">
        {% csrf_token %}
        <button type="submit">Start game</button>
    </form>
{% elif game.winner %}
<p>The last player standing is {{ game.winner }}!</p>
    {% if not most_kills_players %}
    <p>No-one scored above 0 eliminations :(</p>
    {% elif most_kills_players.count == 1 %}
    <p>The player with the most eliminations was {{ most_kills_players.first }} with {{ max_kills }} elimination{{ max_kills|pluralize:"s" }}!</p>
    {% else %}
    <p>The following players had the most eliminations ({{ max_kills }})</p>
    <ul>
        {% for player in most_kills_players %}
        <li>{{ player }}</li>
        {% endfor %}
    </ul>
    {% endif %}
<form action="{% url 'accounts:reset_game_to_start' %}" method="POST">
    {% csrf_token %}
    <button type="submit">Start a new game?</button>
</form>
{% elif game.in_progress %}
<p>Game in progress</p>
{% endif %}
{% if players %}
<h2>Player list</h2>
<table class="player_list">
    <tr>
        <th>Player</th>
        <th>Email</th>
        <th>Secret code</th>
        <th>Target</th>
        {% if game.in_progress == True %}
        <th>Eliminations</th>
        <th>Open</th>
        <th>Time since last assignment</th>
        {% if not game.winner %}
        <th>Manual open</th>
        <th>Manual kill</th>
        {% endif %}
        {% endif %}
        {% if not game.winner %}
        <th>Remove</th>
        {% endif %}
    </tr>
    {% for player in players %}
    <tr class="{% if player.is_open == True %}is_open{% elif player.alive == False %}dead{% endif %}">
        <td>{{ player }}</td>
        <td>{{ player.user.email }}</td>
        <td>{{ player.secret_code }}</td>
        <td>{{ player.target }}</td>
        {% if game.in_progress == True %}
        <td>{{ player.kills }}</td>
        <td>{% if player.is_open == True %}OPEN{% endif %}</td>
        <td>{{ player.inactivity_duration }}</td>
        {% if not game.winner %}        
        <td>
            {% if player.alive == True %}
            <form action="{% url 'accounts:manual_open' %}" method="POST">
                {% csrf_token %}
                <button type="submit">{% if player.manual_open %}Undo{% else %}Set manual open{% endif %}</button>
                <input type="hidden" value="{{ player.pk }}" name="pk">
            </form>
            {% endif %}
        </td>
        <td>
            {% if player.alive == True %}
            <form action="{% url 'accounts:manual_kill' %}" method="POST">
                {% csrf_token %}
                <button type="submit">{% if player.alive %}Manual kill{% else %}Eliminated{% endif %}</button>
                <input type="hidden" value="{{ player.pk }}" name="pk">
            </form>
            {% endif %}
        </td>
        {% endif %}
        {% endif %}
        {% if not game.winner %}
        <td>
            <form action="{% url 'accounts:delete_player' %}" method="POST">
                {% csrf_token %}
                <button type="submit">Delete</button>
                <input type="hidden" value="{{ player.pk }}" name="pk">
            </form>
        </td>
        {% endif %}
    </tr>
    {% endfor %}
</table>
{% endif %}
<h2>{% if not players %}Registered players{% else %}New players{% endif %}</h2>
{% if new_players %}
<table>
    <tr>
        <th>Player</th>
        <th>Email</th>
        {% if players and not game.winner %}
        <th>Add to game</th>
        <th>Remove</th>
        {% endif %}
    </tr>
    {% for player in new_players %}
    <tr>
        <td>{{ player }}</td>
        <td>{{ player.user.email }}</td>
        {% if not game.winner %}
        {% if game.has_sent_info %}
        <td>
            <form action="{% url 'accounts:manual_add' %}" method="POST">
                {% csrf_token %}
                <button type="submit">Add</button>
                <input type="hidden" value="{{ player.pk }}" name="pk">
            </form>            
        </td>
        {% endif %}  
        <td>
            <form action="{% url 'accounts:delete_player' %}" method="POST">
                {% csrf_token %}
                <button type="submit">Delete</button>
                <input type="hidden" value="{{ player.pk }}" name="pk">
            </form>            
        </td>
        {% endif %}
    </tr>
    {% endfor %}
</table>
{% else %}
<p>{% if not players %}No players have registered{% else %}No new players{% endif %}</p>
{% endif %}
{% if players and not game.winner %}
<h2>Target ordering</h2>
<p>{{ target_ordering|linebreaks }}</p>
{% endif %}
{% if not game.winner %}
{% if new_players or players %}
<br>
<form action="{% url 'accounts:reset_player_data' %}" method="POST">
    {% csrf_token %}
    <button type="submit">{% if players %}Reset player data{% else %}Generate secret codes and assign targets{% endif %}</button>
</form>
{% endif %}
{% if game.has_sent_info %}
<br>
<form action="{% url 'accounts:reassign_targets' %}" method="POST">
    {% csrf_token %}
    <button type="submit">Reassign targets</button>
</form>
{% endif %}
{% endif %}
<br>
<form action="{% url 'accounts:populate_players' %}" method="POST">
    {% csrf_token %}
    <button type="submit">Populate with random players (password is 123)</button>
    <input type="hidden" name="pk" value="{{ game.pk }}">
</form>
<br>
<a href="{% url 'accounts:profile' %}">Go back</a>
{% endblock %}